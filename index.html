<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quote Builder — DTF & Screen Print (Google Sheets Catalog)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: 245 245 248;
      --text: 20 23 28;
      --muted: 110 115 125;
      --brand: 88 101 242; /* indigo */
      --brand-2: 157 78 221; /* purple */
      --card: 255 255 255;
      --ok: 16 185 129;
      --warn: 245 158 11;
      --danger: 239 68 68;
      --ring: 59 130 246;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:rgb(var(--text));}
    body{background:linear-gradient(135deg, rgba(var(--brand)/0.06), rgba(var(--brand-2)/0.06)), rgb(var(--bg));}
    .container{max-width:100%;margin-inline:auto;padding:24px;}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(145deg, rgba(var(--brand)/.9), rgba(var(--brand-2)/.9));box-shadow:0 8px 30px rgba(0,0,0,.12)}
    .title{font-weight:800;letter-spacing:.2px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(0,0,0,.08);background:rgb(var(--card));padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600;transition:.15s;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(90deg, rgba(var(--brand)/.95), rgba(var(--brand-2)/.95));color:white;border-color:transparent}
    .btn.ghost{background:transparent;border-color:rgba(0,0,0,.12)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1000px){.grid{grid-template-columns:50% 1fr}}
    .card{background:rgb(var(--card));border:1px solid rgba(0,0,0,.08);border-radius:16px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.04)}
    .card h2{margin:0 0 8px;font-size:18px}
    .sub{color:rgb(var(--muted));font-size:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid rgba(0,0,0,.12);border-radius:12px;background:#fff;outline:none}
    input:focus,select:focus,textarea:focus{border-color:rgb(var(--ring));box-shadow:0 0 0 3px rgba(var(--ring)/.15)}
    label{font-size:12px;color:rgb(var(--muted))}
    .field{display:grid;gap:6px;flex:1;min-width:120px}
    .list{display:block;gap:10px;overflow:scroll}
    .pill{padding:4px 10px;border-radius:999px;background:rgb(var(--bg));border:1px solid rgba(0,0,0,.08);font-size:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid rgba(0,0,0,.06);text-align:left}
    .sectionTitle{font-weight:700;margin:12px 0 4px}
    .muted{color:rgb(var(--muted))}
    .right{margin-left:auto}
    .divider{height:1px;background:linear-gradient(90deg,rgba(0,0,0,.06),transparent)}
    .chip{font-size:11px;padding:4px 8px;border-radius:999px;background:rgba(var(--brand)/.12);color:rgb(var(--brand));font-weight:700}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;background:rgba(var(--ok)/.12);color:rgb(var(--ok));font-weight:700}
    details code{display:block;background:#0f172a;color:#e5e7eb;padding:12px;border-radius:12px;overflow:auto;font-size:12px}
    .stickyActions{position:sticky;bottom:0;display:flex;gap:8px;background:linear-gradient(180deg, transparent, rgba(255,255,255,.9));padding-top:12px}
    .totals{display:grid;grid-template-columns:1fr auto; gap:8px;padding:8px;border-radius:12px;background:rgb(var(--bg));border:1px dashed rgba(0,0,0,.12)}
    .kpi{display:grid;gap:4px;background:rgb(var(--bg));border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:10px;min-width:120px}
    .kpi b{font-size:20px}
    .wrap{display:flex;flex-wrap:wrap;gap:8px}
    .loc{display:flex;align-items:center;gap:8px;padding:8px;border:1px solid rgba(0,0,0,.08);border-radius:12px;background:rgb(var(--bg));}
    .loc input{width:76px}
    .help{font-size:12px;color:rgb(var(--muted))}
    .alert{padding:10px 12px;border-radius:12px;background:rgba(var(--warn)/.12);border:1px solid rgba(var(--warn)/.3)}
    .hidden{display:none}
    .accent{color:rgb(var(--brand))}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px;font-size:12px}
    .kv div{padding:4px 8px;border:1px solid rgba(0,0,0,.06);border-radius:8px;background:rgb(var(--bg))}
    #results{height:40vh;}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">Apparel Quote Builder</div>
          <div class="sub">DTF & Screen Print • Catalog from Google Sheets</div>
        </div>
      </div>
      <div class="row">
        <button class="btn" id="btnNew">New Quote</button>
        <button class="btn primary" id="btnExport">Generate PDF</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Catalog & Sheet Loader -->
      <section class="card">
        <h2>Garment Catalog (Google Sheets)</h2>
        <div class="sub">We will load rows from your sheet and show <b>all columns</b>. Map which columns are price, size, image, etc.</div>

        <div class="row" style="margin-top:10px">
          <div class="field" style="flex:2">
            <label>Google Sheet ID</label>
            <input id="sheetId" value="1EFw4qZn6YSZmPNC_FeW-pSc5PiDPeuaqJe4YjIpgb4U" placeholder="1EFw4qZn6YSZmPNC_FeW-pSc5PiDPeuaqJe4YjIpgb4U" />
          </div>
          <div class="field" style="max-width:160px">
            <label>Sheet GID (tab)</label>
            <input id="sheetGid" placeholder="(optional)" />
          </div>
          <div class="field" style="max-width:130px">
            <label>&nbsp;</label>
            <button class="btn" id="btnLoadSheet">Load Sheet</button>
          </div>
        </div>
        <div class="help" style="margin-top:6px">Tip: In Google Sheets → <b>File → Share → Publish to web</b> → Entire Sheet → CSV. Or provide the <b>GID</b> for a specific tab.</div>

        <div class="row" style="margin-top:10px">
          <div class="field" style="flex:3">
            <label>Auto‑generated CSV URL</label>
            <input id="csvUrl" placeholder="https://docs.google.com/spreadsheets/d/ID/export?format=csv&gid=GID"/>
          </div>
          <div class="field" style="max-width:130px">
            <label>&nbsp;</label>
            <button class="btn ghost" id="btnTestCsv">Test Fetch</button>
          </div>
        </div>

        <div id="loadStatus" class="alert hidden" style="margin-top:10px"></div>

        <div class="divider" style="margin:16px 0"></div>
        <div class="row">
          <div class="field" style="flex:2">
            <label>Search catalog</label>
            <input id="searchInput" placeholder="Search across all columns" />
          </div>
          <div class="field" style="max-width:120px">
            <label>&nbsp;</label>
            <button class="btn" id="btnSearch">Search</button>
          </div>
        </div>

        <div class="sectionTitle">Column Mapping</div>
        <div class="sub">These mappings drive pricing and display. Choices populate after loading the sheet.</div>
        <div id="mapping" class="row" style="margin-top:8px">
          <div class="field"><label>Brand</label><select id="mapBrand"></select></div>
          <div class="field"><label>Style</label><select id="mapStyle"></select></div>
          <div class="field"><label>Color</label><select id="mapColor"></select></div>
          <div class="field"><label>SKU</label><select id="mapSku"></select></div>
          <div class="field"><label>Size</label><select id="mapSize"></select></div>
          <div class="field"><label>Unit Price</label><select id="mapPrice"></select></div>
          <div class="field"><label>Image URL</label><select id="mapImage"></select></div>
        </div>

        <div id="results" class="list" style="margin-top:12px"></div>
      </section>

      <!-- RIGHT: Quote Builder & Preview -->
      <section class="card">
        <h2>Quote Builder</h2>
        <div class="row" style="margin-top:8px">
          <div class="field"><label>Client Name</label><input id="clientName" placeholder="Client / Organization"/></div>
          <div class="field"><label>Client Email</label><input id="clientEmail" placeholder="name@email.com"/></div>
          <div class="field"><label>PO / Ref (optional)</label><input id="clientPO" placeholder="Internal ref"/></div>
        </div>

        <div class="sectionTitle">Placements</div>
        <div class="help">Add decoration locations. DTF is priced by square‑foot of art. Screen print is per color per location with one‑time setup.</div>
        <div id="placements" class="list" style="margin-top:8px"></div>
        <div class="row stickyActions">
          <button class="btn" id="btnAddPlacement">Add Placement</button>
          <span class="right help">Common sizes: Left Chest ~ 4"×4" • Full Front ~ 12"×14" • Neck ~ 3"×3"</span>
        </div>

        <div class="sectionTitle">Settings</div>
        <div class="row wrap">
          <div class="kpi"><span class="muted">DTF $/sqft</span><b id="kpiDTF">$8.00</b></div>
          <div class="kpi"><span class="muted">Screen: Setup /color</span><b id="kpiSetup">$20.00</b></div>
          <div class="kpi"><span class="muted">Screen: Run /color</span><b id="kpiRun">$0.75</b></div>
          <div class="kpi"><span class="muted">Garment Markup</span><b id="kpiMU">35%</b></div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="field"><label>Business / Brand Name</label><input id="brandName" placeholder="Your shop name (for the quote)"/></div>
          <div class="field"><label>Logo URL (optional)</label><input id="logoUrl" placeholder="https://..."/></div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="field"><label>DTF Rate ($/sqft)</label><input type="number" id="dtfRate" step="0.01" value="8"/></div>
          <div class="field"><label>Waste/Overage (%)</label><input type="number" id="wastePct" step="1" value="10"/></div>
          <div class="field"><label>Screen Setup ($/color/location)</label><input type="number" id="spSetup" step="0.01" value="20"/></div>
          <div class="field"><label>Screen Run ($/color)</label><input type="number" id="spRun" step="0.01" value="0.75"/></div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="field"><label>Garment Markup (%)</label><input type="number" id="markupPct" step="1" value="35"/></div>
          <div class="field"><label>Tax Rate (%)</label><input type="number" id="taxPct" step="0.01" value="0"/></div>
          <div class="field"><label>Shipping ($)</label><input type="number" id="shipping" step="0.01" value="0"/></div>
          <div class="field"><label>Terms / Notes</label><input id="terms" placeholder="Lead time, art approval, etc."/></div>
        </div>

        <div class="sectionTitle">Garments in Quote</div>
        <div id="quoteLines" class="list"></div>

        <div class="sectionTitle">Totals</div>
        <div id="totals" class="totals"></div>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnEmail">Compose Email</button>
          <button class="btn" id="btnShare">Copy Shareable URL</button>
          <span class="help right" id="saveInfo"></span>
        </div>
      </section>
    </div>

    <footer class="sub" style="margin-top:16px;text-align:center">No external APIs • Catalog from your Google Sheet • Save/Share is encoded in the URL hash.</footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
  // ---------- State ----------
  const state = {
    settings: {
      dtfRate: 8,
      wastePct: 10,
      spSetup: 20,
      spRun: 0.75,
      markupPct: 35,
      taxPct: 0,
      shipping: 0,
    },
    brand: { name: '', logo: '' },
    client: { name: '', email: '', po: '' },
    placements: [],
    lines: [],
    catalog: [], // array of row objects {col: val}
    columns: [], // header names
    mapping: { brand:'', style:'', color:'', sku:'', size:'', price:'', image:'' },
    sheet: { id:'', gid:'', csvUrl:'' }
  };

  const defaultLocations = ['Left Chest','Right Chest','Full Front','Full Back','Sleeve Left','Sleeve Right','Neck/Locker','Hood'];
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  // ---------- Google Sheet helpers ----------
  function buildCsvUrl(id, gid){
    if(!id) return '';
    if(gid){ return `https://docs.google.com/spreadsheets/d/${id}/export?format=csv&gid=${gid}`; }
    // fallback to the first sheet via gviz CSV (works if the sheet is viewable)
    return `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv`;
  }

  async function fetchCsv(url){
    const r = await fetch(url, { cache: 'no-store' });
    if(!r.ok) throw new Error(`Fetch failed: ${r.status}`);
    const text = await r.text();
    return new Promise((resolve, reject)=>{
      Papa.parse(text, { header:true, skipEmptyLines:true, complete: res=> resolve(res.data), error: err=> reject(err) });
    });
  }

  function hydrateMappings(){
    const selects = ['mapBrand','mapStyle','mapColor','mapSku','mapSize','mapPrice','mapImage'].map(id=>$("#"+id));
    selects.forEach(sel=>{ sel.innerHTML = `<option value="">— none —</option>` + state.columns.map(c=>`<option value="${c}">${c}</option>`).join(''); });
    // Try to auto-guess common headers
    const guess = (names) => state.columns.find(h=> names.some(n=> h.toLowerCase().includes(n)) ) || '';
    state.mapping.brand ||= guess(['brand']);
    state.mapping.style ||= guess(['style','model']);
    state.mapping.color ||= guess(['color']);
    state.mapping.sku   ||= guess(['sku','item','code']);
    state.mapping.size  ||= guess(['size']);
    state.mapping.price ||= guess(['price','cost']);
    state.mapping.image ||= guess(['image','img','photo','thumbnail']);
    // set selects
    $('#mapBrand').value = state.mapping.brand;
    $('#mapStyle').value = state.mapping.style;
    $('#mapColor').value = state.mapping.color;
    $('#mapSku').value = state.mapping.sku;
    $('#mapSize').value = state.mapping.size;
    $('#mapPrice').value = state.mapping.price;
    $('#mapImage').value = state.mapping.image;
  }

  function setLoadStatus(msg, ok=false){
    const el = $('#loadStatus');
    el.classList.remove('hidden');
    el.style.borderColor = ok? 'rgba(16,185,129,.4)' : 'rgba(245,158,11,.3)';
    el.style.background = ok? 'rgba(16,185,129,.12)' : 'rgba(245,158,11,.12)';
    el.innerHTML = msg;
  }

  async function loadSheet(){
    try{
      const id = $('#sheetId').value.trim();
      const gid = $('#sheetGid').value.trim();
      if(!id){ setLoadStatus('Please paste your <b>Google Sheet ID</b>. It\'s the long string in the URL.', false); return; }
      const url = buildCsvUrl(id, gid);
      $('#csvUrl').value = url;
      setLoadStatus('Loading CSV…');
      const rows = await fetchCsv(url);
      if(!rows || !rows.length){ setLoadStatus('Loaded but found no rows. Ensure the sheet/tab has data and is published to the web as CSV.', false); return; }
      state.sheet = { id, gid, csvUrl: url };
      state.catalog = rows.map(r=> Object.fromEntries(Object.entries(r).map(([k,v])=>[String(k).trim(), String(v??'').trim()])) );
      state.columns = Object.keys(state.catalog[0]||{});
      setLoadStatus(`Loaded <b>${state.catalog.length}</b> rows with <b>${state.columns.length}</b> columns.`, true);
      hydrateMappings();
      renderResults(state.catalog);
    }catch(err){
      setLoadStatus(`Error: ${err.message}. Make sure the sheet is publicly viewable or <b>Publish to the web → CSV</b>.`, false);
      renderResults([]);
    }
  }

  // ---------- Catalog ----------
  function searchCatalog(){
    const q = $('#searchInput').value.trim().toLowerCase();
    if(!q){ renderResults(state.catalog); return; }
    const filtered = state.catalog.filter(row=> Object.values(row).some(val => String(val).toLowerCase().includes(q)) );
    renderResults(filtered);
  }

  function renderResults(items){
    const container = $('#results');
    container.innerHTML = '';
    if(!items.length){ container.innerHTML = '<div class="muted">No results. Load your sheet and try searching.</div>'; return; }

    const get = (row, key) => key && row[key] != null ? row[key] : '';

    items.slice(0, 200).forEach((row,i)=>{
      const image = get(row, state.mapping.image);
      const brand = get(row, state.mapping.brand);
      const style = get(row, state.mapping.style);
      const color = get(row, state.mapping.color);
      const sku   = get(row, state.mapping.sku);
      const size  = get(row, state.mapping.size) || 'One Size';
      const price = parseFloat(String(get(row, state.mapping.price)).replace(/[^0-9.\-]/g,'')) || 0;

      const card = document.createElement('div');
      card.className = 'list';
      card.style.cssText='border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:10px;background:rgb(var(--bg));';
      card.innerHTML = `
        <div class="row" style="align-items:center">
          <img src="${image || 'https://via.placeholder.com/64x64?text=IMG'}" alt="" style="width:64px;height:64px;object-fit:cover;border-radius:10px;border:1px solid rgba(0,0,0,.06)"/>
          <div style="flex:1">
            <div style="font-weight:700">${brand||''} ${style||''} <span class="muted">• ${color||''}</span></div>
            <div class="sub">SKU: ${sku||''} ${state.mapping.price?`<span class='pill'>Price: $${price.toFixed(2)}</span>`:''}</div>
          </div>
          <div class="row" style="gap:6px">
            <input type="text" value="${size}" id="size-${i}" style="width:110px"/>
            <input type="number" min="0" value="12" id="qty-${i}" style="width:90px"/>
            <button class="btn" data-idx="${i}">Add</button>
          </div>
        </div>
        <details style="margin-top:8px">
          <summary>View row data</summary>
          <div class="kv" style="margin-top:8px">${state.columns.map(c=>`<div>${c}</div><div>${row[c]??''}</div>`).join('')}</div>
        </details>
      `;
      card.querySelector('button').onclick = () => {
        const qty = Number(document.getElementById(`qty-${i}`).value||0);
        const sizeInput = document.getElementById(`size-${i}`).value || 'One Size';
        if(!qty) return;
        addLineFromRow(row, sizeInput, qty, price, image, brand, style, color);
      };
      container.appendChild(card);
    });
  }

  function addLineFromRow(row, size, qty, price, image, brand, style, color){
    const keyBrand = brand || '';
    const keyStyle = style || '';
    const keyColor = color || '';
    // Find or create a line grouping by brand/style/color
    let line = state.lines.find(l => l.brandName===keyBrand && l.styleName===keyStyle && l.colorName===keyColor && l.image===image);
    if(!line){
      line = { id: crypto.randomUUID(), styleName: keyStyle, brandName: keyBrand, colorName: keyColor, image: image, units: [], meta: row };
      state.lines.push(line);
    }
    const found = line.units.find(u=>u.size===size);
    if(found){ found.qty += qty; found.unitPrice = price; } else { line.units.push({ size, qty, unitPrice: price }); }
    renderLines(); calcTotals();
  }

  function renderLines(){
    const host = $('#quoteLines');
    host.innerHTML = '';
    if(!state.lines.length){ host.innerHTML = '<div class="muted">No garments added yet. Use the catalog on the left.</div>'; return; }
    state.lines.forEach(line =>{
      const el = document.createElement('div');
      el.className='list';
      el.style.cssText='border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:10px;background:rgb(var(--bg));';
      const totalQty = line.units.reduce((a,b)=>a+Number(b.qty||0),0);
      const garmentSub = line.units.reduce((sum,u)=> sum + Number(u.qty||0) * Number(u.unitPrice||0), 0);
      el.innerHTML = `
        <div class="row" style="align-items:center">
          <img src="${line.image || 'https://via.placeholder.com/56x56?text=IMG'}" style="width:56px;height:56px;border-radius:10px;border:1px solid rgba(0,0,0,.06);object-fit:cover"/>
          <div style="flex:1">
            <div style="font-weight:700">${line.brandName||''} ${line.styleName||''} • ${line.colorName||''}</div>
            <div class="sub">Qty: <b>${totalQty}</b></div>
          </div>
          <button class="btn ghost" data-del="${line.id}">Remove</button>
        </div>
        <table class="table">
          <thead><tr><th>Size</th><th>Qty</th><th>Unit $</th><th>Ext $</th></tr></thead>
          <tbody>
            ${line.units.map(u=>`<tr>
              <td>${u.size}</td>
              <td><input type="number" min="0" value="${u.qty}" data-line="${line.id}" data-size="${u.size}" class="sizeQty"/></td>
              <td>$${Number(u.unitPrice).toFixed(2)}</td>
              <td>$${(Number(u.qty)*Number(u.unitPrice)).toFixed(2)}</td>
            </tr>`).join('')}
          </tbody>
        </table>
        <details><summary>Show all item fields</summary>
          <div class="kv" style="margin-top:8px">${state.columns.map(c=>`<div>${c}</div><div>${line.meta?.[c]??''}</div>`).join('')}</div>
        </details>
        <div class="row"><span class="muted">Garment subtotal (before markup):</span><b class="right">$${garmentSub.toFixed(2)}</b></div>
      `;
      el.querySelector('[data-del]').onclick = ()=>{ state.lines = state.lines.filter(x=>x.id!==line.id); renderLines(); calcTotals(); };
      el.querySelectorAll('.sizeQty').forEach(inp=>{
        inp.oninput = ()=>{
          const L = state.lines.find(x=>x.id===inp.dataset.line);
          const unit = L.units.find(u=>u.size===inp.dataset.size);
          unit.qty = Number(inp.value||0); calcTotals();
        };
      })
      host.appendChild(el);
    })
  }

  // ---------- Pricing Engine ----------
  function perPieceDecoration(){
    let setup = 0; let perPiece = 0;
    state.placements.forEach(p=>{
      if(p.technique==='DTF'){
        const sqft = (Number(p.width)||0) * (Number(p.height)||0) / 144;
        const base = sqft * Number($('#dtfRate').value||state.settings.dtfRate);
        const withWaste = base * (1 + (Number($('#wastePct').value||state.settings.wastePct)/100));
        perPiece += withWaste;
      } else {
        const colors = Math.max(1, Number(p.colors)||1);
        perPiece += colors * Number($('#spRun').value||state.settings.spRun);
        setup += colors * Number($('#spSetup').value||state.settings.spSetup);
      }
    });
    return { perPiece, setup };
  }

  function calcTotals(){
    $('#kpiDTF').textContent = `$${Number($('#dtfRate').value||state.settings.dtfRate).toFixed(2)}`;
    $('#kpiSetup').textContent = `$${Number($('#spSetup').value||state.settings.spSetup).toFixed(2)}`;
    $('#kpiRun').textContent = `$${Number($('#spRun').value||state.settings.spRun).toFixed(2)}`;
    $('#kpiMU').textContent = `${Number($('#markupPct').value||state.settings.markupPct)}%`;

    const totals = { qty:0, garmentCost:0, garmentSell:0, decoPerPiece:0, setup:0, decoTotal:0, shipping: Number($('#shipping').value||0), tax:0, grand:0 };
    const { perPiece, setup } = perPieceDecoration();
    totals.decoPerPiece = perPiece; totals.setup = setup;

    state.lines.forEach(line=>{
      const lineQty = line.units.reduce((a,b)=>a+Number(b.qty||0),0);
      const lineCost = line.units.reduce((sum,u)=> sum + Number(u.qty||0)*Number(u.unitPrice||0), 0);
      totals.qty += lineQty; totals.garmentCost += lineCost;
    });

    const markup = 1 + (Number($('#markupPct').value||state.settings.markupPct)/100);
    totals.garmentSell = totals.garmentCost * markup;
    totals.decoTotal = (totals.qty * totals.decoPerPiece) + totals.setup;
    const sub = totals.garmentSell + totals.decoTotal + totals.shipping;
    totals.tax = sub * (Number($('#taxPct').value||state.settings.taxPct)/100);
    totals.grand = sub + totals.tax;

    $('#totals').innerHTML = `
      <div class="muted">Total Pieces</div><div><b>${totals.qty}</b></div>
      <div class="muted">Garments (w/ markup)</div><div><b>$${totals.garmentSell.toFixed(2)}</b></div>
      <div class="muted">Decoration per piece</div><div><b>$${totals.decoPerPiece.toFixed(2)}</b></div>
      <div class="muted">Screen setups</div><div><b>$${totals.setup.toFixed(2)}</b></div>
      <div class="muted">Decoration total</div><div><b>$${totals.decoTotal.toFixed(2)}</b></div>
      <div class="muted">Shipping</div><div><b>$${totals.shipping.toFixed(2)}</b></div>
      <div class="muted">Tax</div><div><b>$${totals.tax.toFixed(2)}</b></div>
      <div class="muted">Grand Total</div><div><b>$${totals.grand.toFixed(2)}</b></div>
    `;
    return totals;
  }

  // ---------- Placements ----------
  function addPlacement(){
    state.placements.push({ id: crypto.randomUUID(), location: defaultLocations[Math.min(state.placements.length, defaultLocations.length-1)] || 'Custom', technique: 'DTF', width: 4, height: 4, colors: 1 });
    renderPlacements(); calcTotals();
  }
  function renderPlacements(){
    const host = $('#placements'); host.innerHTML='';
    if(!state.placements.length){ host.innerHTML = '<div class="muted">No placements yet.</div>'; return; }
    state.placements.forEach(p=>{
      const row = document.createElement('div'); row.className = 'loc';
      row.innerHTML = `
        <select data-id="${p.id}" data-key="location">
          ${defaultLocations.concat(['Custom']).map(loc=>`<option ${p.location===loc?'selected':''}>${loc}</option>`).join('')}
        </select>
        <select data-id="${p.id}" data-key="technique">
          ${['DTF','Screen Print'].map(t=>`<option ${p.technique===t?'selected':''}>${t}</option>`).join('')}
        </select>
        <label>W (in)</label><input type="number" min="1" step="0.1" value="${p.width}" data-id="${p.id}" data-key="width" />
        <label>H (in)</label><input type="number" min="1" step="0.1" value="${p.height}" data-id="${p.id}" data-key="height" />
        <label class="colorsLab ${p.technique==='Screen Print'?'':'hidden'}">Colors</label>
        <input class="colorsInp ${p.technique==='Screen Print'?'':'hidden'}" type="number" min="1" step="1" value="${p.colors}" data-id="${p.id}" data-key="colors" />
        <button class="btn ghost right" data-remove="${p.id}">Remove</button>
      `;
      row.querySelectorAll('select,input').forEach(el=>{
        el.oninput = ()=>{
          const pl = state.placements.find(x=>x.id===el.dataset.id);
          const key = el.dataset.key; let val = el.value;
          if(['width','height','colors'].includes(key)) val = Number(val);
          if(key==='technique'){
            row.querySelector('.colorsLab').classList.toggle('hidden', val!=='Screen Print');
            row.querySelector('.colorsInp').classList.toggle('hidden', val!=='Screen Print');
          }
          pl[key] = val; calcTotals();
        }
      });
      row.querySelector('[data-remove]').onclick = ()=>{ state.placements = state.placements.filter(x=>x.id!==p.id); renderPlacements(); calcTotals(); };
      host.appendChild(row);
    });
  }

  // ---------- Export: PDF / Email / Share ----------
  async function exportPDF(){
    const totals = calcTotals();
    const { jsPDF } = window.jspdf; const doc = new jsPDF({ unit:'pt', format:'a4' });
    const pad = 36; let y = pad;
    const brand = $('#brandName').value || 'Quote';
    doc.setFont('helvetica','bold'); doc.setFontSize(18); doc.text(`${brand} — Quote`, pad, y);
    doc.setFont('helvetica','normal'); doc.setFontSize(10);
    y+=16; doc.text(`Client: ${$('#clientName').value || ''}  •  Email: ${$('#clientEmail').value || ''}  •  Ref: ${$('#clientPO').value || ''}`, pad, y);
    y+=10; doc.text(new Date().toLocaleString(), pad, y);
    y+=14; doc.setDrawColor(220); doc.line(pad, y, 559, y); y+=14;

    doc.setFont('helvetica','bold'); doc.text('Placements', pad, y); y+=12; doc.setFont('helvetica','normal');
    if(!state.placements.length){ doc.text('— None —', pad, y); y+=14; }
    else{ state.placements.forEach(p=>{ doc.text(`• ${p.location} — ${p.technique} — ${p.width}"×${p.height}"${p.technique==='Screen Print'?` — ${p.colors} color(s)`:''}`, pad, y); y+=12; }); }

    y+=6; doc.setDrawColor(240); doc.line(pad, y, 559, y); y+=14;
    doc.setFont('helvetica','bold'); doc.text('Garments', pad, y); y+=12; doc.setFont('helvetica','normal');
    if(!state.lines.length){ doc.text('— None —', pad, y); y+=14; }
    else{
      state.lines.forEach(line=>{
        const qty = line.units.reduce((a,b)=>a+Number(b.qty||0),0);
        doc.text(`${line.brandName||''} ${line.styleName||''} — ${line.colorName||''} — Qty ${qty}`, pad, y); y+=12;
        const sizes = line.units.map(u=>`${u.size}:${u.qty}`).join('  ');
        doc.text(`Sizes: ${sizes}`, pad+12, y); y+=14;
      });
    }

    y+=6; doc.setDrawColor(240); doc.line(pad, y, 559, y); y+=14;
    doc.setFont('helvetica','bold'); doc.text('Totals', pad, y); y+=14; doc.setFont('helvetica','normal');
    const lines = [
      [`Total Pieces`, String(totals.qty)],
      [`Garments (w/ markup)`, `$${totals.garmentSell.toFixed(2)}`],
      [`Decoration per piece`, `$${totals.decoPerPiece.toFixed(2)}`],
      [`Screen setups`, `$${totals.setup.toFixed(2)}`],
      [`Decoration total`, `$${totals.decoTotal.toFixed(2)}`],
      [`Shipping`, `$${totals.shipping.toFixed(2)}`],
      [`Tax`, `$${totals.tax.toFixed(2)}`],
      [`Grand Total`, `$${totals.grand.toFixed(2)}`],
    ];
    lines.forEach(([k,v])=>{ doc.text(`${k}`, pad, y); doc.text(v, 559, y, { align:'right' }); y+=14; });

    y+=10; const terms = $('#terms').value || '';
    if(terms){ doc.setFont('helvetica','bold'); doc.text('Notes', pad, y); y+=12; doc.setFont('helvetica','normal'); doc.text(terms, pad, y, { maxWidth: 523 }); y+=24; }

    doc.save(`${(brand||'Quote').split(' ').join('_')}_Quote.pdf`);
  }

  function composeEmail(){
    const t = calcTotals();
    const subject = encodeURIComponent(`Quote from ${$('#brandName').value || 'our shop'} — $${t.grand.toFixed(2)}`);
    const lines = state.lines.map(l=>{
      const qty = l.units.reduce((a,b)=>a+Number(b.qty||0),0);
      const sizes = l.units.map(u=>`${u.size}:${u.qty}`).join(' ');
      return `• ${l.brandName||''} ${l.styleName||''} ${l.colorName||''} — Qty ${qty} — Sizes ${sizes}`;
    }).join('%0A');
    const places = state.placements.map(p=>`• ${p.location} — ${p.technique} — ${p.width}\"×${p.height}\"${p.technique==='Screen Print'?` — ${p.colors} color(s)`:''}`).join('%0A');
    const body = `Hello,%0A%0AHere is your quote:%0A%0APlacements:%0A${places}%0A%0AGarments:%0A${lines}%0A%0ATotals:%0AGrand: $${t.grand.toFixed(2)} (incl. tax/shipping if shown)%0A%0A— ${$('#brandName').value || ''}`;
    const mailto = `mailto:${encodeURIComponent($('#clientEmail').value || '')}?subject=${subject}&body=${body}`;
    window.location.href = mailto;
  }

  function copyShareUrl(){
    const snapshot = JSON.stringify(state);
    const encoded = btoa(unescape(encodeURIComponent(snapshot)));
    const url = `${location.origin}${location.pathname}#q=${encoded}`;
    navigator.clipboard.writeText(url).then(()=>{ $('#saveInfo').textContent='Copied shareable URL'; setTimeout(()=>$('#saveInfo').textContent='', 2000); });
  }

  function loadFromHash(){
    const match = location.hash.match(/#q=(.+)$/);
    if(!match) return;
    try{
      const data = JSON.parse(decodeURIComponent(escape(atob(match[1]))));
      Object.assign(state, data);
      // hydrate inputs
      $('#brandName').value = state.brand.name || '';
      $('#logoUrl').value = state.brand.logo || '';
      $('#dtfRate').value = state.settings.dtfRate;
      $('#wastePct').value = state.settings.wastePct;
      $('#spSetup').value = state.settings.spSetup;
      $('#spRun').value = state.settings.spRun;
      $('#markupPct').value = state.settings.markupPct;
      $('#taxPct').value = state.settings.taxPct;
      $('#shipping').value = state.settings.shipping;
      $('#clientName').value = state.client.name || '';
      $('#clientEmail').value = state.client.email || '';
      $('#clientPO').value = state.client.po || '';
      $('#sheetId').value = state.sheet.id || '';
      $('#sheetGid').value = state.sheet.gid || '';
      $('#csvUrl').value = state.sheet.csvUrl || '';
      hydrateMappings();
      renderPlacements(); renderLines(); calcTotals();
    }catch(e){ console.warn('Failed to load from URL', e); }
  }

  // ---------- Wire up ----------
  $('#btnLoadSheet').onclick = loadSheet;
  $('#btnTestCsv').onclick = async ()=>{ if(!$('#csvUrl').value) return; setLoadStatus('Testing URL…'); try{ const rows = await fetchCsv($('#csvUrl').value); state.catalog = rows; state.columns = Object.keys(rows[0]||{}); setLoadStatus(`OK — ${rows.length} rows` , true); hydrateMappings(); renderResults(rows);} catch(e){ setLoadStatus('Failed to fetch CSV: '+ e.message, false);} };
  $('#btnSearch').onclick = searchCatalog;
  $('#searchInput').addEventListener('keydown', e=>{ if(e.key==='Enter') searchCatalog(); });

  $('#btnAddPlacement').onclick = addPlacement;
  $('#btnExport').onclick = exportPDF;
  $('#btnEmail').onclick = composeEmail;
  $('#btnShare').onclick = copyShareUrl;
  $('#btnNew').onclick = ()=>{ location.hash=''; location.reload(); };

  // Keep settings/state in sync
  ;['dtfRate','wastePct','spSetup','spRun','markupPct','taxPct','shipping','brandName','logoUrl','clientName','clientEmail','clientPO','terms'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.oninput = ()=>{
      if(['dtfRate','wastePct','spSetup','spRun','markupPct','taxPct','shipping'].includes(id)){
        state.settings[id] = Number(el.value||0);
      }
      if(['brandName','logoUrl'].includes(id)) state.brand[id==='brandName'?'name':'logo'] = el.value;
      if(['clientName','clientEmail','clientPO'].includes(id)) state.client[{clientName:'name',clientEmail:'email',clientPO:'po'}[id]] = el.value;
      calcTotals();
    };
  });

  // Map selects
  ;['mapBrand','mapStyle','mapColor','mapSku','mapSize','mapPrice','mapImage'].forEach(id=>{
    const el = document.getElementById(id);
    el.onchange = ()=>{ const key = id.replace('map','').toLowerCase(); state.mapping[key] = el.value; if(state.catalog.length){ renderResults(state.catalog); } };
  });

  // Initial render
  renderResults([]); renderPlacements(); renderLines(); calcTotals();
  if(location.hash.includes('#q=')) loadFromHash();
  // === Mockup Preview — uses line.image from Quote Builder ===
    (function(){
      const canvas = document.getElementById('mockCanvas');
      const stage = document.getElementById('mockStage');
      const sel = document.getElementById('mockLine');
      if(!canvas || !stage || !sel) return;
      const ctx = canvas.getContext('2d');
      const urlInput = document.getElementById('designUrl');
      const fileInput = document.getElementById('designFile');
      const scaleInp = document.getElementById('mockScale');
      const rotInp = document.getElementById('mockRotate');
      const opInp = document.getElementById('mockOpacity');
      const centerBtn = document.getElementById('btnCenterOverlay');
      const exportBtn = document.getElementById('btnExportPng');

      const mock = { garmentUrl:'', garmentImg:new Image(), designUrl:'', designImg:new Image(), x:0, y:0, scale:0.4, rot:0, opacity:1, dragging:false, dx:0, dy:0 };

      function fitCanvasToStage(){
        const w = stage.clientWidth || 600;
        const ar = (mock.garmentImg && mock.garmentImg.naturalWidth) ? (mock.garmentImg.naturalWidth / (mock.garmentImg.naturalHeight||1)) : 1;
        const h = Math.max(260, Math.round(w / (ar||1)));
        canvas.width = w; canvas.height = h;
      }
      function draw(){
        ctx.clearRect(0,0,canvas.width, canvas.height);
        if(mock.garmentUrl && mock.garmentImg.complete && mock.garmentImg.naturalWidth){
          const gw = mock.garmentImg.naturalWidth; const gh = mock.garmentImg.naturalHeight;
          const s = Math.max(canvas.width/gw, canvas.height/gh);
          const dw = gw*s, dh = gh*s; const dx = (canvas.width - dw)/2, dy = (canvas.height - dh)/2;
          ctx.drawImage(mock.garmentImg, dx, dy, dw, dh);
        }
        if(mock.designUrl && mock.designImg.complete && mock.designImg.naturalWidth){
          const iw = mock.designImg.naturalWidth, ih = mock.designImg.naturalHeight;
          const base = Math.min(canvas.width, canvas.height);
          const drawW = base * mock.scale, drawH = drawW * (ih/iw);
          ctx.save(); ctx.globalAlpha = mock.opacity; ctx.translate(mock.x, mock.y); ctx.rotate(mock.rot * Math.PI/180);
          ctx.drawImage(mock.designImg, -drawW/2, -drawH/2, drawW, drawH);
          ctx.restore();
        }
      }
      function populateLines(){
        const prev = sel.value;
        const opts = (state.lines||[]).map(l=>`<option value="${l.id}">${(l.brandName||'')} ${(l.styleName||'')} • ${(l.colorName||'')}</option>`).join('');
        sel.innerHTML = `<option value="">— choose garment from quote —</option>${opts}`;
        if(prev && [...sel.options].some(o=>o.value===prev)) sel.value = prev;
      }
      function centerOverlay(){ mock.x = Math.round(canvas.width/2); mock.y = Math.round(canvas.height/2); }
      function loadGarmentFromLine(){
        const line = (state.lines||[]).find(l=>l.id===sel.value);
        if(!line){ mock.garmentUrl=''; draw(); return; }
        mock.garmentUrl = line.image || '';
        const img = new Image(); img.crossOrigin = 'anonymous';
        img.onload = ()=>{ mock.garmentImg = img; fitCanvasToStage(); centerOverlay(); draw(); };
        img.onerror = ()=>{ mock.garmentImg = img; fitCanvasToStage(); draw(); };
        img.src = mock.garmentUrl;
      }
      function setDesignFromUrl(u){
        if(!u){ mock.designUrl=''; draw(); return; }
        const img = new Image(); img.crossOrigin = 'anonymous';
        img.onload = ()=>{ mock.designImg = img; if(mock.x===0 && mock.y===0) centerOverlay(); draw(); };
        img.onerror = ()=>{ alert('Could not load design image URL'); };
        img.src = u; mock.designUrl = u;
      }
      // Dragging & wheel zoom
      function toCanvas(evt){ const r = canvas.getBoundingClientRect(); return { x: (evt.clientX - r.left), y: (evt.clientY - r.top) }; }
      canvas.addEventListener('mousedown', e=>{ if(!mock.designUrl) return; const p = toCanvas(e); mock.dragging=true; mock.dx = p.x - mock.x; mock.dy = p.y - mock.y; });
      window.addEventListener('mouseup', ()=>{ mock.dragging=false; });
      canvas.addEventListener('mousemove', e=>{ if(!mock.dragging) return; const p = toCanvas(e); mock.x = p.x - mock.dx; mock.y = p.y - mock.dy; draw(); });
      canvas.addEventListener('wheel', e=>{ if(!mock.designUrl) return; e.preventDefault(); const d = e.deltaY>0?-0.05:0.05; mock.scale = Math.max(0.05, Math.min(5, mock.scale+d)); scaleInp.value = String(mock.scale); draw(); }, { passive:false });

      // Controls
      sel.addEventListener('change', loadGarmentFromLine);
      if(fileInput){ fileInput.addEventListener('change', ()=>{ const f = fileInput.files && fileInput.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=> setDesignFromUrl(r.result); r.readAsDataURL(f); }); }
      if(urlInput){ urlInput.addEventListener('change', ()=> setDesignFromUrl(urlInput.value.trim())); }
      if(scaleInp){ scaleInp.addEventListener('input', ()=>{ mock.scale = Number(scaleInp.value||1); draw(); }); }
      if(rotInp){ rotInp.addEventListener('input', ()=>{ mock.rot = Number(rotInp.value||0); draw(); }); }
      if(opInp){ opInp.addEventListener('input', ()=>{ mock.opacity = Number(opInp.value||1); draw(); }); }
      if(centerBtn){ centerBtn.addEventListener('click', ()=>{ centerOverlay(); draw(); }); }
      if(exportBtn){ exportBtn.addEventListener('click', ()=>{ try{ const url = canvas.toDataURL('image/png'); const a = document.createElement('a'); a.href=url; a.download='mockup.png'; a.click(); } catch(e){ alert('Export blocked by image host (CORS). You can still screenshot this preview.'); } }); }

      new ResizeObserver(()=>{ fitCanvasToStage(); draw(); }).observe(stage);

      // Hook into renderLines so options stay in sync
      if(window.renderLines){ const orig = window.renderLines; window.renderLines = function(){ const r = orig.apply(this, arguments); populateLines(); draw(); return r; }; }

      // Initial
      populateLines(); fitCanvasToStage(); draw();
    })();
  </script>
</body>
</html>
